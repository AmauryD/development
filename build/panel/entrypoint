#!/usr/bin/env bash
set -x

if [ ! -z "$WWWUSER" ]; then
  sudo usermod -u $WWWUSER pterodactyl
fi

if [ -d "/etc/php/mods-available"]; then
  if [ -d "/etc/php/mods-available/cli" ]; then
    sudo ln -s /etc/php/mods-available/cli/* /etc/php/8.1/cli/conf.d
  fi
  if [ -d "/etc/php/mods-available/fpm" ]; then
    sudo ln -s /etc/php/mods-available/fpm/* /etc/php/8.1/fpm/conf.d
  fi
  find . -maxdepth 1 -type f -print0 | while read -d $'\0' file
  do
    sudo ln -s "$file" /etc/php/8.1/cli/conf.d/
    sudo ln -s "$file" /etc/php/8.1/fpm/conf.d/
  done
fi

if [ -d "/etc/certs" ]; then
  sudo mkdir -p /usr/local/share/ca-certificates/mkcert
  sudo cp /etc/certs/pterodactyl*.pem /usr/local/share/ca-certificates/mkcert/
  sudo update-ca-certificates
fi

cd /var/www/html || exit 1
sudo chown -R pterodactyl:www-data storage
sudo chmod -R 777 storage/* bootstrap/cache

if [ $# -gt 0 ]; then
  sudo su -c "/bin/bash"
else
  sudo service cron start
  sudo /usr/bin/supervisord -c /etc/supervisord.conf -n
fi
